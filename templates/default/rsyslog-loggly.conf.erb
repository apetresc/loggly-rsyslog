# This file was generated by Chef

##########################################################
### RsyslogTemplate for Loggly ###
##########################################################

<% if @monitor_files %>
$ModLoad imfile

	<% node['loggly']['log_files'].each do |logfile| %>
$InputFileName <%= logfile['filename'] %>
$InputFileTag <%= logfile['tag'] %>:
$InputFileStateFile <%= logfile['statefile'] %>
$InputRunFileMonitor
	<% end %>

  <% node['loggly']['log_dirs'].each do |logdir| %>
    <% Dir.foreach(logdir['directory']) do |filename| %>
      <% if filename =~ /[\w\.-_\d]+\.log$/ %>
$InputFileName <%= "#{logdir['directory']}/#{filename}" %>
$InputFileTag <%= logdir['tag'] %>:
$InputFileStateFile state-<%= filename %>
$InputRunFileMonitor

      <% end %>
    <% end %>
  <% end %>

$InputFilePollInterval <%= node['loggly']['rsyslog']['input_file_poll_interval'] %>
<% end %>

$WorkDirectory /var/spool/rsyslog # where to place spool files
$ActionQueueFileName fwdRule1 # unique name prefix for spool files
$ActionQueueMaxDiskSpace 1g   # 1gb space limit (use as much as possible)
$ActionQueueSaveOnShutdown on # save messages to disk on shutdown
$ActionQueueType LinkedList   # run asynchronously
$ActionResumeRetryCount -1    # infinite retries if host is down

<% if node['loggly']['tls']['enabled'] %>
#RsyslogGnuTLS
$DefaultNetstreamDriverCAFile <%= node['loggly']['tls']['cert_path'] %>/loggly.com.crt

template(name="LogglyFormat" type="string"
string="<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 tag=\"RsyslogTLS\" <%= @tags %>] %msg%\n"
)

# Send messages to Loggly over TCP using the template.
action(type="omfwd" protocol="tcp" target="<%= node['loggly']['rsyslog']['host'] %>" port="<%= node['loggly']['rsyslog']['port'] %>" template="LogglyFormat" StreamDriver="gtls" StreamDriverMode="1" StreamDriverAuthMode="x509/name" StreamDriverPermittedPeers="*.loggly.com")
<% else %>
$template LogglyFormat,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 <%= @tags %>] %msg%\n"
# Send messages to Loggly over TCP using the template.
*.* @@<%= node['loggly']['rsyslog']['host'] %>:<%= node['loggly']['rsyslog']['port'] %>;LogglyFormat
<% end %>

#################END CONFIG FILE#########################
